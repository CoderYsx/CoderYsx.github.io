

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="https://pic.downk.cc/item/5ff67d1e3ffa7d37b3ddf825.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>ElasticSearch - Ysx&#39;Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Ysx's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-07 14:23" pubdate>
        2021年1月7日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      208
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">ElasticSearch</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h1><h2 id="1-什么是RestFul"><a href="#1-什么是RestFul" class="headerlink" title="1. 什么是RestFul"></a>1. 什么是RestFul</h2><blockquote>
<p><strong>REST</strong> :  表现层状态转化(Representational State Transfer)，如果一个架构符合REST原则，就称它为 RESTful 架构风格。 </p>
<p>**资源(Resources): 所谓”资源”，就是网络上的一个实体，或者说是网络上的一个具体信息 </p>
<p><strong>表现层</strong>(Representation) :我们把”资源”具体呈现出来的形式，叫做它的”表现层”。</p>
<p><strong>状态转化(State Transfer)</strong>:如果客户端想要操作服务器，必须通过某种手段，让服务器端发生”状态转 化”(State Transfer)。而这种转化是建立在表现层之上的，所以就是”表现层状态转化”。</p>
</blockquote>
<blockquote>
<p><strong>REST原则就是指一个URL代表一个唯一资源，并且通过HTTP协议里面四个动词:GET、POST、PUT、DELETE对应四种服务器端的基本操作: GET用来获取资源，POST用来更新资源(也可以用于添加资源)，PUT用来添加资源(也可以用于更新资源)，DELETE用来删除资源。</strong></p>
</blockquote>
<h2 id="2-什么是全文检索"><a href="#2-什么是全文检索" class="headerlink" title="2. 什么是全文检索"></a>2. 什么是全文检索</h2><blockquote>
<p><strong>全文检索是计算机程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置。当用户查询时根据建立的索引查找，类似于通过字典的检索字表查字的过程。</strong></p>
<p>全文检索（Full-Text Retrieval(检索)）以文本作为检索对象，找出含有指定词汇的文本。<strong>全面、准确和快速是衡量全文检索系统的关键指标。</strong></p>
<blockquote>
<p>关于全文检索，我们要知道：</p>
</blockquote>
<p>** 1. 只处理文本。**</p>
<p>   <strong>2. 不处理语义。</strong></p>
<p>   <strong>3. 搜索时英文不区分大小写。</strong></p>
<p>   <strong>4. 结果列表有相关度排序。</strong></p>
</blockquote>
<h2 id="3-什么是ElasticSearch"><a href="#3-什么是ElasticSearch" class="headerlink" title="3. 什么是ElasticSearch"></a>3. 什么是ElasticSearch</h2><blockquote>
<p><strong>ElasticSearch</strong> 简称 <strong>ES</strong> ，<strong>是基于Apache Lucene构建的开源搜索引擎，是当前流行的企业级搜索引擎(分布式搜索引擎)**。Lucene本身就可以被认为迄今为止性能最好的一款开源搜索引擎工具包，但是lucene的API相对复杂，需要深厚的搜索理论。很难集成到实际的应用中去。</strong>同时ES是采用java语言编写，提供了简单易用的RestFul API，开发者可以使用其简单的RestFul API，开发相关的搜索功能，从而避免lucene的复杂性**。   搜索检索         数据库like</p>
</blockquote>
<hr>
<h2 id="4-ES的诞生"><a href="#4-ES的诞生" class="headerlink" title="4. ES的诞生"></a>4. ES的诞生</h2><blockquote>
<p>多年前，一个叫做Shay Banon 的刚结婚不久的失业开发者，由于妻子要去伦敦学习厨师，他便跟着也去了。在他找工作的过程中，为了给妻子构建一个食谱的搜索引擎，他开始构建一个早期版本的Lucene。</p>
<p>直接基于Lucene工作会比较困难，所以Shay开始抽象Lucene代码以便Java程序员可以在应用中添加搜索功能。他发布了他的第一个开源项目，叫做“Compass”。</p>
<p>后来Shay找到一份工作，这份工作处在高性能和内存数据网格的分布式环境中，因此高性能的、实时的、分布式的搜索引擎也是理所当然需要的。然后他决定重写Compass库使其成为一个独立的服务叫做Elasticsearch。</p>
<p>第一个公开版本出现在2010年2月，在那之后Elasticsearch已经成为Github上最受欢迎的项目之一，代码贡献者超过300人。一家主营Elasticsearch的公司就此成立，他们一边提供商业支持一边开发新功能，不过Elasticsearch将永远开源且对所有人可用。</p>
<p>Shay的妻子依旧等待着她的食谱搜索……</p>
</blockquote>
<hr>
<h2 id="5-ES的应用场景-json格式数据-restful"><a href="#5-ES的应用场景-json格式数据-restful" class="headerlink" title="5. ES的应用场景 json格式数据  restful"></a>5. ES的应用场景 json格式数据  restful</h2><blockquote>
<p><strong>Es主要以轻量级JSON作为数据存储格式，这点与MongoDB有点类似，但它在读写性能上优于 MongoDB 。同时也支持地理位置查询 ，还方便地理位置和文本混合查询 。 以及在统计、日志类数据存储和分析、可视化这方面是引领者。</strong></p>
<p><strong>国外:</strong> </p>
<p>​    <strong>Wikipedia</strong>(维基百科)使用ES提供全文搜索并高亮关键字、<strong>StackOverflow</strong>(IT问答网站)结合全文搜索与地理位置查询、<strong>Github</strong>使用Elasticsearch检索1300亿行的代码。 </p>
<p><strong>国内:</strong></p>
<p>​    <strong>百度</strong>(在云分析、网盟、预测、文库、钱包、风控等业务上都应用了ES，单集群每天导入30TB+数据， 总共每天60TB+)、<strong>新浪 、阿里巴巴、腾讯</strong>等公司均有对ES的使用。</p>
</blockquote>
<blockquote>
<p><strong>使用比较广泛的平台ELK(ElasticSearch 全文检索服务器 核心, Logstash, Kibana)。</strong> </p>
</blockquote>
<h2 id="6-ES的安装"><a href="#6-ES的安装" class="headerlink" title="6. ES的安装"></a>6. ES的安装</h2><pre><code class="hljs markdown"><span class="hljs-section"># 0. 安装前准备</span>
<span class="hljs-code">	centos7 +</span>
<span class="hljs-code">	java 8  +</span>
<span class="hljs-code">	elastic 6.2.4+</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 1. 在官方网站下载ES</span>
<span class="hljs-code">		wget http://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.4.1.tar.gz</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 2. 安装JDK(必须JDK1.8+)</span>
<span class="hljs-code">		rpm -ivh jdk-8u181-linux-x64.rpm</span>
<span class="hljs-code">			/*注意:默认安装位置 /usr/java/jdk1.8.0_171-amd64*/</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 3. 配置环境变量</span>
<span class="hljs-code">	vim /etc/profile</span>
<span class="hljs-code">	在文件末尾加入:</span>
<span class="hljs-code">		export JAVA_HOME=/usr/java/jdk1.8.0_171-amd64</span>
<span class="hljs-code">		export PATH=$PATH:$JAVA_HOME/bin</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 4. 重载系统配置</span>
<span class="hljs-code">		source /etc/profile</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 5.创建普通用户(es不能作为root用户启动)</span>
<span class="hljs-code">		a.在linux系统中创建新的组</span>
<span class="hljs-code">			groupadd es</span>
<span class="hljs-code"></span>
<span class="hljs-code">		b.创建新的用户es并将es用户放入es组中</span>
<span class="hljs-code">			useradd es -g es </span>
<span class="hljs-code"></span>
<span class="hljs-code">		c.修改es用户密码</span>
<span class="hljs-code">			passwd es</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 6.上传es到普通用户的家目录,并安装elasticsearch</span>
<span class="hljs-code">		tar -zxvf elasticsearch-6.4.1.tar.gz</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 7. elasticsearche的目录结构</span>
<span class="hljs-code">        bin                         可执行的二进制文件的目录</span>
<span class="hljs-code">        config                    	配置文件的目录</span>
<span class="hljs-code">        lib                         运行时依赖的库</span>
<span class="hljs-code">        logs  modules       		运行时日志文件</span>
<span class="hljs-code">        plugins                   	es中提供的插件</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 8. 运行es服务</span>
<span class="hljs-code">		在bin目录中执行   ./elasticsearch</span>
<span class="hljs-code"></span>
<span class="hljs-code">		</span>
<span class="hljs-code"># 9. 测试ES是否启动成功</span>
<span class="hljs-code">	在命令终端中执行: curl http://localhost:9200 出现以下信息:</span>
<span class="hljs-code">		&#123;</span>
<span class="hljs-code">          &quot;name&quot; : &quot;xQK1cwT&quot;,</span>
<span class="hljs-code">          &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span>
<span class="hljs-code">          &quot;cluster_uuid&quot; : &quot;t7IYk7LKQ0mXcyyrdFWpLg&quot;,</span>
<span class="hljs-code">          &quot;version&quot; : &#123;</span>
<span class="hljs-code">            &quot;number&quot; : &quot;6.2.4&quot;,</span>
<span class="hljs-code">            &quot;build_hash&quot; : &quot;ccec39f&quot;,</span>
<span class="hljs-code">            &quot;build_date&quot; : &quot;2018-04-12T20:37:28.497551Z&quot;,</span>
<span class="hljs-code">            &quot;build_snapshot&quot; : false,</span>
<span class="hljs-code">            &quot;lucene_version&quot; : &quot;7.2.1&quot;,</span>
<span class="hljs-code">            &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,</span>
<span class="hljs-code">            &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;</span>
<span class="hljs-code">          &#125;,</span>
<span class="hljs-code">          &quot;tagline&quot; : &quot;You Know, for Search&quot;</span>
<span class="hljs-code">        &#125;</span>
<span class="hljs-code">        </span>
<span class="hljs-code"># 11. 开启ES远程访问</span>
<span class="hljs-code">		vim elasticsearch.yml 将原来network修改为以下配置:</span>
<span class="hljs-code">		network.host: 0.0.0.0</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 12. 启动时错误解决方案</span>
<span class="hljs-code">	a.重新启动es出现如下错误</span>
<span class="hljs-code">	  **ERROR: bootstrap checks failed[1]: max file descriptors [4096] for elasticsearch process is too low, </span>
<span class="hljs-code">	   increase to at least [65536]**</span>
<span class="hljs-code">      解决方案:</span>
<span class="hljs-code">       # 切换到root用户修改</span>
<span class="hljs-code">        vim /etc/security/limits.conf</span>
<span class="hljs-code">       # 在最后面追加下面内容</span>
<span class="hljs-code">        *               soft    nofile          65536</span>
<span class="hljs-code">        *               hard    nofile          65536</span>
<span class="hljs-code">        *               soft    nproc           4096</span>
<span class="hljs-code">        *               hard    nproc           4096</span>
<span class="hljs-code">       # 退出重新登录检测配置是否生效:</span>
<span class="hljs-code">        ulimit -Hn</span>
<span class="hljs-code">        ulimit -Sn</span>
<span class="hljs-code">        ulimit -Hu</span>
<span class="hljs-code">        ulimit -Su</span>
<span class="hljs-code"></span>
<span class="hljs-code">	b.重新启动出现如下错误</span>
<span class="hljs-code">	  **ERROR: max number of threads [3802] for user [chenyn] is too low,increase to at least [4096]**</span>
<span class="hljs-code">       解决方案:</span>
<span class="hljs-code">       #进入limits.d目录下修改配置文件。</span>
<span class="hljs-code">        vim /etc/security/limits.d/20-nproc.conf </span>
<span class="hljs-code">       # 修改为 启动ES用户名 soft nproc 4096</span>
<span class="hljs-code">       </span>
<span class="hljs-code">    c.重新启动出现如下错误</span>
<span class="hljs-code">	  **ERROR: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]**</span>
<span class="hljs-code">       解决方案:</span>
<span class="hljs-code">        vim /etc/sysctl.conf</span>
<span class="hljs-code">        vm.max_map_count=655360</span>
<span class="hljs-code">       #执行以下命令生效：</span>
<span class="hljs-code">        sysctl -p</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 13. 关闭网络防火墙</span>
<span class="hljs-code">		systemctl stop firewalld   关闭本次防火墙服务</span>
<span class="hljs-code">		systemctl disable firewalld 关闭开启自启动防火墙服务</span>
<span class="hljs-code"></span>
<span class="hljs-code"># 14. 外部浏览器访问即可</span>
<span class="hljs-code">	http://es的主机名:9200 出现如下信息说明安装成功:</span>
<span class="hljs-code">	&#123;</span>
<span class="hljs-code">        &quot;name&quot; : &quot;xQK1cwT&quot;,</span>
<span class="hljs-code">        &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span>
<span class="hljs-code">        &quot;cluster_uuid&quot; : &quot;t7IYk7LKQ0mXcyyrdFWpLg&quot;,</span>
<span class="hljs-code">        &quot;version&quot; : &#123;</span>
<span class="hljs-code">        &quot;number&quot; : &quot;6.2.4&quot;,</span>
<span class="hljs-code">        &quot;build_hash&quot; : &quot;ccec39f&quot;,</span>
<span class="hljs-code">        &quot;build_date&quot; : &quot;2018-04-12T20:37:28.497551Z&quot;,</span>
<span class="hljs-code">        &quot;build_snapshot&quot; : false,</span>
<span class="hljs-code">        &quot;lucene_version&quot; : &quot;7.2.1&quot;,</span>
<span class="hljs-code">        &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,</span>
<span class="hljs-code">        &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;</span>
<span class="hljs-code">        &#125;,</span>
<span class="hljs-code">        &quot;tagline&quot; : &quot;You Know, for Search&quot;</span>
<span class="hljs-code">   	&#125;</span></code></pre>

<hr>
<h2 id="7-ES中基本概念"><a href="#7-ES中基本概念" class="headerlink" title="7. ES中基本概念"></a>7. ES中基本概念</h2><h3 id="7-1-接近实时-Near-Real-Time-简称NRT"><a href="#7-1-接近实时-Near-Real-Time-简称NRT" class="headerlink" title="7.1 接近实时(Near Real Time 简称NRT)"></a>7.1 接近实时(Near Real Time 简称NRT)</h3><blockquote>
<p><strong>Elasticsearch是一个接近实时的搜索平台</strong>。这意味着，<strong>从索引一个文档直到这个文档能够被搜索到有一个轻微的延迟(通常是1秒内)</strong> </p>
</blockquote>
<h3 id="7-2-索引-index"><a href="#7-2-索引-index" class="headerlink" title="7.2 索引(index)"></a>7.2 索引(index)</h3><blockquote>
<p><strong><code>一个索引就是一个拥有几分相似特征的文档的集合</code>**。比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。</strong><code>一个索引由一个名字来标识(必须全部是小写字母的)</code><strong>，</strong><code>并且当我们要对这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字</code><strong>。</strong><code>索引类似于关系型数据库中Database 的概念</code>**。在一个集群中，如果你想，可以定义任意多的索引。 </p>
</blockquote>
<h3 id="7-3-类型-type"><a href="#7-3-类型-type" class="headerlink" title="7.3 类型(type)"></a>7.3 类型(type)</h3><blockquote>
<p><strong><code>一个类型是你的索引的一个逻辑上的分类/分区，其语义完全由你来定</code>**。在一个索引中，你可以定义一种或多种类型。通常，会为具有一组共同字段的文档定义一个类型。比如说，我们假设你运营一个博客平台并且将你所有的数 据存储到一个索引中。在这个索引中，你可以为用户数据定义一个类型，为博客数据定义另一个类型，当然，也可 以为评论数据定义另一个类型。</strong><code>类型类似于关系型数据库中Table的概念</code>**。 </p>
<p><strong>NOTE: 在5.x版本以前可以在一个索引中定义多个类型,6.x之后版本也可以使用,但是不推荐,在8.x版本中彻底移除一个索引中创建多个类型</strong></p>
</blockquote>
<h3 id="7-4-映射-Mapping"><a href="#7-4-映射-Mapping" class="headerlink" title="7.4 映射(Mapping)"></a>7.4 映射(Mapping)</h3><blockquote>
<p><strong>Mapping</strong>是ES中的一个很重要的内容，**<code>它类似于传统关系型数据中table的schema，用于定义一个索引(index)中的类型(type)的数据的结构</code><strong>。 在ES中，我们可以手动创建type(相当于table)和mapping(相关与schema),也可以采用默认创建方式。</strong><code>在默认配置下，ES可以根据插入的数据自动地创建type及其mapping。 mapping中主要包括字段名、字段数据类型和字段索引类型</code>** </p>
</blockquote>
<h3 id="7-5-文档-document"><a href="#7-5-文档-document" class="headerlink" title="7.5 文档(document)"></a>7.5 文档(document)</h3><blockquote>
<p><strong><code>一个文档是一个可被索引的基础信息单元，类似于表中的一条记录</code>。</strong>比如，你可以拥有某一个员工的文档,也可以拥有某个商品的一个文档。文档以采用了轻量级的数据交换格式JSON(Javascript Object Notation)来表示。 </p>
</blockquote>
<hr>
<h2 id="8-Kibana的安装"><a href="#8-Kibana的安装" class="headerlink" title="8. Kibana的安装"></a>8. Kibana的安装</h2><pre><code class="hljs markdown">Kibana是一个针对Elasticsearch的开源分析及可视化平台，使用Kibana可以查询、查看并与存储在ES索引的数据进行交互操作，使用Kibana能执行高级的数据分析，并能以图表、表格和地图的形式查看数据

<span class="hljs-bullet">1.</span> 下载Kibana
<span class="hljs-code">	https://www.elastic.co/downloads/kibana</span>
<span class="hljs-code"></span>
<span class="hljs-code">2. 安装下载的kibana</span>
<span class="hljs-code">	rpm -ivh kibana-6.2.4-x86_64.rpm</span>
<span class="hljs-code"></span>
<span class="hljs-code">3. 查找kibana的安装位置</span>
<span class="hljs-code">	find / -name kibana</span>
<span class="hljs-code">    </span>
<span class="hljs-code">4. 编辑kibana配置文件</span>
<span class="hljs-code">	[root@localhost /]# vim /etc/kibana/kibana.yml</span>
<span class="hljs-code"></span>
<span class="hljs-code">5. 修改如下配置</span>
<span class="hljs-code">	server.host: &quot;10.102.115.3&quot;                		#ES服务器主机名</span>
<span class="hljs-code">	elasticsearch.url: &quot;http://10.102.115.3:9200&quot;   #ES服务器地址</span>
<span class="hljs-code"></span>
<span class="hljs-code">6. 启动kibana</span>
<span class="hljs-code">	systemctl start kibana</span>
<span class="hljs-code">	systemctl stop  kibana</span>
<span class="hljs-code">	systemctl status kibana</span>
<span class="hljs-code"></span>
<span class="hljs-code">7. 访问kibana的web界面  </span>
<span class="hljs-code">	http://10.102.115.3:5601/   #kibana默认端口为5601 使用主机:端口直接访问即可    </span></code></pre>

<hr>
<h2 id="9-Kibana的基本操作"><a href="#9-Kibana的基本操作" class="headerlink" title="9. Kibana的基本操作"></a>9. Kibana的基本操作</h2><h3 id="9-1-索引-Index-的基本操作"><a href="#9-1-索引-Index-的基本操作" class="headerlink" title="9.1 索引(Index)的基本操作"></a>9.1 索引(Index)的基本操作</h3><pre><code class="hljs http">PUT /dangdang/       	  	创建索引
DELETE /dangdang			删除索引
DELETE /*					删除所有索引
GET /_cat/indices?v 		查看索引信息</code></pre>



<h3 id="9-2-类型-type-的基本操作"><a href="#9-2-类型-type-的基本操作" class="headerlink" title="9.2 类型(type)的基本操作"></a>9.2 类型(type)的基本操作</h3><h4 id="创建类型"><a href="#创建类型" class="headerlink" title="创建类型"></a>创建类型</h4><pre><code class="hljs http"><span class="hljs-attribute">1.创建/dangdang索引并创建(product)类型</span>
PUT /dangdang             
&#123;
  &quot;mappings&quot;: &#123;
    &quot;product&quot;: &#123;
      &quot;properties&quot;: &#123;
        	&quot;title&quot;:    &#123; &quot;type&quot;: &quot;text&quot;  &#125;,
        	&quot;name&quot;:     &#123; &quot;type&quot;: &quot;text&quot;  &#125;,
       		&quot;age&quot;:      &#123; &quot;type&quot;: &quot;integer&quot; &#125;,
        	&quot;created&quot;:  &#123;
         		 &quot;type&quot;:   &quot;date&quot;,
          		 &quot;format&quot;: &quot;strict_date_optional_time||epoch_millis&quot;
        		&#125;
      		&#125;
    	&#125;
  	&#125;
&#125;
注意: 这种方式创建类型要求索引不能存在</code></pre>

<blockquote>
<p>Mapping Type: <strong>: text , keyword , date ,integer, long , double , boolean or ip</strong></p>
</blockquote>
<h4 id="查看类型"><a href="#查看类型" class="headerlink" title="查看类型"></a>查看类型</h4><pre><code class="hljs http">GET /dangdang/_mapping/product # 语法:GET /索引名/_mapping/类型名</code></pre>



<h3 id="9-3-文档-document-的基本操作"><a href="#9-3-文档-document-的基本操作" class="headerlink" title="9.3 文档(document)的基本操作"></a>9.3 文档(document)的基本操作</h3><h4 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h4><pre><code class="hljs http">PUT /ems/emp/1   #/索引/类型/id
&#123;
  &quot;name&quot;:&quot;赵小六&quot;,
  &quot;age&quot;:23,
  &quot;bir&quot;:&quot;2012-12-12&quot;,
  &quot;content&quot;:&quot;这是一个好一点的员工&quot;
&#125;</code></pre>

<h4 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h4><pre><code class="hljs json">GET /ems/emp/1  
返回结果:
&#123;
  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ems&quot;</span>,
  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;emp&quot;</span>,
  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,
  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">&quot;_source&quot;</span>: &#123;
    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;赵小六&quot;</span>,
    <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">23</span>,
    <span class="hljs-attr">&quot;bir&quot;</span>: <span class="hljs-string">&quot;2012-12-12&quot;</span>,
    <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;这是一个好一点的员工&quot;</span>
  &#125;
&#125;</code></pre>

<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><pre><code class="hljs json">DELETE /ems/emp/1
&#123;
  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ems&quot;</span>,
  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;emp&quot;</span>,
  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,
  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,
  &quot;result&quot;: &quot;deleted&quot;, #删除成功
  &quot;_shards&quot;: &#123;
    &quot;total&quot;: 2,
    &quot;successful&quot;: 1,
    &quot;failed&quot;: 0
  &#125;,
  &quot;_seq_no&quot;: 1,
  &quot;_primary_term&quot;: 1
&#125;</code></pre>

<h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><pre><code class="hljs http">1.第一种方式  更新原有的数据
   POST /dangdang/emp/1/_update
    &#123;
      &quot;doc&quot;:&#123;
        &quot;name&quot;:&quot;xiaohei&quot;
      &#125;
    &#125;
2.第二种方式  添加新的数据
    POST /ems/emp/1/_update
    &#123;
      &quot;doc&quot;:&#123;
        &quot;name&quot;:&quot;xiaohei&quot;,
        &quot;age&quot;:11,
        &quot;dpet&quot;:&quot;你好部门&quot;
      &#125;
    &#125;
3.第三种方式 在原来数据基础上更新
	POST /ems/emp/1/_update
    &#123;
      &quot;script&quot;: &quot;ctx._source.age += 5&quot;
    &#125;</code></pre>

<pre><code class="hljs markdown">ES的使用语法风格为:
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">REST</span> <span class="hljs-attr">Verb</span>&gt;</span></span> /<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Index</span>&gt;</span></span>/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Type</span>&gt;</span></span>/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ID</span>&gt;</span></span>
REST操作    /索引/类型/文档id</code></pre>

<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><pre><code class="hljs http">1. 批量索引两个文档
    PUT /dangdang/emp/_bulk
 	&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125; 
  		&#123;&quot;name&quot;: &quot;John Doe&quot;,&quot;age&quot;:23,&quot;bir&quot;:&quot;2012-12-12&quot;&#125;
	&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;  
  		&#123;&quot;name&quot;: &quot;Jane Doe&quot;,&quot;age&quot;:23,&quot;bir&quot;:&quot;2012-12-12&quot;&#125;
    
2. 更新文档同时删除文档
    POST /dangdang/emp/_bulk
		&#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;
			&#123;&quot;doc&quot;:&#123;&quot;name&quot;:&quot;lisi&quot;&#125;&#125;
		&#123;&quot;delete&quot;:&#123;&quot;_id&quot;:2&#125;&#125;
		&#123;&quot;index&quot;:&#123;&#125;&#125;
			&#123;&quot;name&quot;:&quot;xxx&quot;,&quot;age&quot;:23&#125;
 
注意:批量时不会因为一个失败而全部失败,二十继续执行后续操作,批量在返回时按照执行的状态开始返回</code></pre>

<hr>
<h2 id="10-ES中高级检索"><a href="#10-ES中高级检索" class="headerlink" title="10. ES中高级检索"></a>10. ES中高级检索</h2><h3 id="10-1-检索方式"><a href="#10-1-检索方式" class="headerlink" title="10.1 检索方式"></a>10.1 检索方式</h3><blockquote>
<p>ES官方提供了两中检索方式:<strong>一种是通过 URL 参数进行搜索,另一种是通过 DSL(Domain Specified Language) 进行搜索</strong>。<strong>官方更推荐使用第二种方式第二种方式是基于传递JSON作为请求体(request body)格式与ES进行交互，这种方式更强大，更简洁</strong>。</p>
</blockquote>
<h3 id="10-2-测试数据"><a href="#10-2-测试数据" class="headerlink" title="10.2 测试数据"></a>10.2 测试数据</h3><pre><code class="hljs json">1.删除索引
DELETE /ems

2.创建索引并指定类型
PUT /ems
&#123;
  <span class="hljs-attr">&quot;mappings&quot;</span>:&#123;
    <span class="hljs-attr">&quot;emp&quot;</span>:&#123;
      <span class="hljs-attr">&quot;properties&quot;</span>:&#123;
        <span class="hljs-attr">&quot;name&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;age&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;bir&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;date&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;content&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;address&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span>
        &#125;
      &#125;
    &#125;
  &#125;
&#125;

3.插入测试数据
PUT /ems/emp/_bulk
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;小黑&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">23</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;为开发团队选择一款优秀的MVC框架是件难事儿，在众多可行的方案中决择需要很高的经验和水平&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;王小黑&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">24</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Spring 框架是一个分层架构，由 7 个定义良好的模块组成。Spring 模块构建在核心容器之上，核心容器定义了创建、配置和管理 bean 的方式&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;上海&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张小五&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">8</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Spring Cloud 作为Java 语言的微服务框架，它依赖于Spring Boot，有快速开发、持续交付和容易部署等特点。Spring Cloud 的组件非常多，涉及微服务的方方面面，井在开源社区Spring 和Netflix 、Pivotal 两大公司的推动下越来越完善&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;无锡&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;win7&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">9</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Spring的目标是致力于全方位的简化Java开发。 这势必引出更多的解释， Spring是如何简化Java开发的？&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;南京&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;梅超风&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">43</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;杭州&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张无忌&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">59</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京&quot;</span>&#125;</code></pre>



<h3 id="10-2-URL检索"><a href="#10-2-URL检索" class="headerlink" title="10.2 URL检索"></a>10.2 URL检索</h3><blockquote>
<p>*<em>GET /ems/emp/_search?q=</em>&amp;sort=age:asc**</p>
<p>​    _search 搜索的API<br>​    q=*     匹配所有文档<br>​    sort    以结果中的指定字段排序</p>
</blockquote>
<h3 id="10-3-DSL检索"><a href="#10-3-DSL检索" class="headerlink" title="10.3 DSL检索"></a>10.3 DSL检索</h3><blockquote>
<p><strong>NOTE: 以下重点讲解DSL语法</strong></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
    &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,
    &quot;sort&quot;: [
        &#123;
            &quot;age&quot;: &#123;
                &quot;order&quot;: &quot;desc&quot;
            &#125;
        &#125;
    ]
&#125;
</code></pre>



<h3 id="10-4-DSL高级检索-Query"><a href="#10-4-DSL高级检索-Query" class="headerlink" title="10.4 DSL高级检索(Query)"></a>10.4 DSL高级检索(Query)</h3><h4 id="0-查询所有-match-all"><a href="#0-查询所有-match-all" class="headerlink" title="0. 查询所有(match_all)"></a>0. 查询所有(match_all)</h4><blockquote>
<p><strong>match_all关键字:</strong>  返回索引中的全部文档</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
 	&quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;
&#125;</code></pre>



<h4 id="1-查询结果中返回指定条数-size"><a href="#1-查询结果中返回指定条数-size" class="headerlink" title="1. 查询结果中返回指定条数(size)"></a>1. 查询结果中返回指定条数(size)</h4><blockquote>
<p><strong>size 关键字</strong>: 指定查询结果中返回指定条数。  <strong>默认返回值10条</strong></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
 	&quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,
	&quot;size&quot;: 1
&#125;</code></pre>



<h4 id="2-分页查询-from"><a href="#2-分页查询-from" class="headerlink" title="2. 分页查询(from)"></a>2. 分页查询(from)</h4><blockquote>
<p><strong>from 关键字</strong>: 用来指定起始返回位置，和<strong>size关键字连用可实现分页效果</strong></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
      &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,
      &quot;sort&quot;: [
        &#123;
          &quot;age&quot;: &#123;
            &quot;order&quot;: &quot;desc&quot;
          &#125;
        &#125;
      ],
      &quot;size&quot;: 2, 
      &quot;from&quot;: 1
&#125;</code></pre>



<h4 id="3-查询结果中返回指定字段-source"><a href="#3-查询结果中返回指定字段-source" class="headerlink" title="3. 查询结果中返回指定字段(_source)"></a>3. 查询结果中返回指定字段(_source)</h4><blockquote>
<p><strong>_source 关键字</strong>: 是一个数组,在数组中用来指定展示那些字段</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
      &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,
      &quot;_source&quot;: [&quot;account_number&quot;, &quot;balance&quot;]
&#125;</code></pre>



<h4 id="4-关键词查询-term"><a href="#4-关键词查询-term" class="headerlink" title="4. 关键词查询(term)"></a>4. 关键词查询(term)</h4><blockquote>
<p> <strong>term 关键字</strong>: 用来使用关键词查询</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;term&quot;: &#123;
      &quot;address&quot;: &#123;
        &quot;value&quot;: &quot;北京&quot;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<blockquote>
<p><strong>NOTE1:  通过使用term查询得知ES中默认使用分词器为标准分词器(StandardAnalyzer),标准分词器对于英文单词分词,对于中文单字分词</strong>。</p>
<p><strong>NOTE2:  通过使用term查询得知,在ES的Mapping Type 中 keyword , date ,integer, long , double , boolean or ip 这些类型不分词</strong>，<strong>只有text类型分词</strong>。</p>
</blockquote>
<h4 id="5-范围查询-range"><a href="#5-范围查询-range" class="headerlink" title="5. 范围查询(range)"></a>5. 范围查询(range)</h4><blockquote>
<p><strong>range 关键字</strong>: 用来指定查询指定范围内的文档</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;age&quot;: &#123;
        &quot;gte&quot;: 8,
        &quot;lte&quot;: 30
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="6-前缀查询-prefix"><a href="#6-前缀查询-prefix" class="headerlink" title="6. 前缀查询(prefix)"></a>6. 前缀查询(prefix)</h4><blockquote>
<p><strong>prefix 关键字</strong>: 用来检索含有指定前缀的关键词的相关文档</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;prefix&quot;: &#123;
      &quot;content&quot;: &#123;
        &quot;value&quot;: &quot;redis&quot;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="7-通配符查询-wildcard"><a href="#7-通配符查询-wildcard" class="headerlink" title="7. 通配符查询(wildcard)"></a>7. 通配符查询(wildcard)</h4><blockquote>
<p><strong>wildcard 关键字</strong>: 通配符查询     *<em>? 用来匹配一个任意字符  * 用来匹配多个任意字符*</em></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;wildcard&quot;: &#123;
      &quot;content&quot;: &#123;
        &quot;value&quot;: &quot;re*&quot;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="8-多id查询-ids"><a href="#8-多id查询-ids" class="headerlink" title="8. 多id查询(ids)"></a>8. 多id查询(ids)</h4><blockquote>
<p><strong>ids 关键字</strong> : 值为数组类型,用来根据一组id获取多个对应的文档</p>
</blockquote>
<pre><code class="hljs http">GET  /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;ids&quot;: &#123;
      &quot;values&quot;: [&quot;lg5HwWkBxH7z6xax7W3_&quot;,&quot;lQ5HwWkBxH7z6xax7W3_&quot;]
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="9-模糊查询-fuzzy"><a href="#9-模糊查询-fuzzy" class="headerlink" title="9. 模糊查询(fuzzy)"></a>9. 模糊查询(fuzzy)</h4><blockquote>
<p><strong>fuzzy 关键字</strong>: 用来模糊查询含有指定关键字的文档  注意:允许出现的错误必须在0-2之间</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;fuzzy&quot;: &#123;
      &quot;content&quot;:&quot;spoong&quot;
    &#125;
  &#125;
&#125;

# 注意: 最大编辑距离为 0 1 2
如果关键词为2个长度      0..2 must match exactly  必须完全匹配
如果关键词长度3..5之间  one edit allowed    允许一个失败
如果关键词长度&gt;5   two edits allowed       最多允许两个错误</code></pre>

<h4 id="10-布尔查询-bool"><a href="#10-布尔查询-bool" class="headerlink" title="10. 布尔查询(bool)"></a>10. 布尔查询(bool)</h4><blockquote>
<p><strong>bool 关键字</strong>: 用来组合多个条件实现复杂查询  boolb表达式查询</p>
<p>​    <strong>must: 相当于&amp;&amp; 同时成立</strong></p>
<p>​    <strong>should: 相当于|| 成立一个就行</strong></p>
<p>​    <strong>must_not: 相当于!  不能满足任何一个</strong></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;
          &quot;range&quot;: &#123;
            &quot;age&quot;: &#123;
              &quot;gte&quot;: 0,
              &quot;lte&quot;: 30
            &#125;
          &#125;
        &#125;
      ],
      &quot;must_not&quot;: [
        &#123;&quot;wildcard&quot;: &#123;
          &quot;content&quot;: &#123;
            &quot;value&quot;: &quot;redi?&quot;
          &#125;
        &#125;&#125;
      ]
    &#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;age&quot;: &#123;
        &quot;order&quot;: &quot;desc&quot;
      &#125;
    &#125;
  ]
&#125;</code></pre>

<h4 id="11-高亮查询-highlight"><a href="#11-高亮查询-highlight" class="headerlink" title="11. 高亮查询(highlight)"></a>11. 高亮查询(highlight)</h4><blockquote>
<p><strong>highlight 关键字</strong>: 可以让符合条件的文档中的关键词高亮</p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;term&quot;: &#123;
      &quot;content&quot;: &#123;
        &quot;value&quot;: &quot;redis&quot;
      &#125;
    &#125;
  &#125;,
  &quot;highlight&quot;: &#123;
    &quot;fields&quot;: &#123;
      &quot;*&quot;: &#123;&#125;
    &#125;
  &#125;
&#125;</code></pre>

<blockquote>
<p><strong>自定义高亮html标签</strong>: 可以在highlight中使用<code>pre_tags</code>和<code>post_tags</code></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;:&#123;
    &quot;term&quot;:&#123;
      &quot;content&quot;:&quot;框架&quot;
    &#125;
  &#125;,
  &quot;highlight&quot;: &#123;
    &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;],
    &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;],
    &quot;fields&quot;: &#123;
      &quot;*&quot;:&#123;&#125;
    &#125;
  &#125;
&#125;</code></pre>

<blockquote>
<p>多字段高亮 使用<code>require_field_match</code>开启多个字段高亮</p>
</blockquote>
<pre><code class="hljs http"> GET /ems/emp/_search
&#123;
  &quot;query&quot;:&#123;
    &quot;term&quot;:&#123;
      &quot;content&quot;:&quot;框架&quot;
    &#125;
  &#125;,
  &quot;highlight&quot;: &#123;
    &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;],
    &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;],
    &quot;require_field_match&quot;:false,
    &quot;fields&quot;: &#123;
      &quot;*&quot;:&#123;&#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="12-多字段查询-multi-match"><a href="#12-多字段查询-multi-match" class="headerlink" title="12. 多字段查询(multi_match)"></a>12. 多字段查询(multi_match)</h4><blockquote>
<p><code>注意:使用这种方式进行查询时,为了更好获取搜索结果,在查询过程中先将查询条件根据当前的分词器分词之后进行查询</code></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;multi_match&quot;: &#123;
      &quot;query&quot;: &quot;中国&quot;,
      &quot;fields&quot;: [&quot;name&quot;,&quot;content&quot;] #这里写要检索的指定字段
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="13-多字段分词查询-query-String"><a href="#13-多字段分词查询-query-String" class="headerlink" title="13. 多字段分词查询(query_String)"></a>13. 多字段分词查询(query_String)</h4><blockquote>
<p><code>注意:使用这种方式进行查询时,为了更好获取搜索结果,在查询过程中先将查询条件根据当前的分词器分词之后进行查询</code></p>
</blockquote>
<pre><code class="hljs http">GET /dangdang/book/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;query_string&quot;: &#123;
      &quot;query&quot;: &quot;中国声音&quot;,
      &quot;analyzer&quot;: &quot;ik_max_word&quot;, 
      &quot;fields&quot;: [&quot;name&quot;,&quot;content&quot;]
    &#125;
  &#125;
&#125;
</code></pre>



<hr>
<h2 id="11-IK分词器"><a href="#11-IK分词器" class="headerlink" title="11. IK分词器"></a>11. IK分词器</h2><blockquote>
<p><strong>NOTE: 默认ES中采用标准分词器进行分词,这种方式并不适用于中文网站,因此需要修改ES对中文友好分词,从而达到更加的搜索的效果。</strong></p>
</blockquote>
<h3 id="11-1-在线安装IK"><a href="#11-1-在线安装IK" class="headerlink" title="11.1 在线安装IK"></a>11.1 在线安装IK</h3><blockquote>
<p>在线安装IK  (v5.5.1版本后开始支持在线安装 )</p>
</blockquote>
<pre><code class="hljs shell">1. 在es安装目录中执行如下命令

[es@linux elasticsearch-6.2.4]$ ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.4/elasticsearch-analysis-ik-6.2.4.zip
<span class="hljs-meta">-&gt;</span><span class="bash"> Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.4/elasticsearch-analysis-ik-6.2.4.zip</span>
[=================================================] 100%
<span class="hljs-meta">-&gt;</span><span class="bash"> Installed analysis-ik</span>
[es@linux elasticsearch-6.2.4]$ ls plugins/
analysis-ik
[es@linux elasticsearch-6.2.4]$ cd plugins/analysis-ik/
[es@linux analysis-ik]$ ls
commons-codec-1.9.jar    elasticsearch-analysis-ik-6.2.4.jar  httpcore-4.4.4.jar
commons-logging-1.2.jar  httpclient-4.5.2.jar                 plugin-descriptor.properties


2. 重启es生效
</code></pre>

<blockquote>
<p><strong>NOTE: 要求版本严格与当前使用版本一致,如需使用其他版本替换 <code>6.2.4</code> 为使用的版本号</strong></p>
</blockquote>
<h3 id="11-2-本地安装IK"><a href="#11-2-本地安装IK" class="headerlink" title="11.2 本地安装IK"></a>11.2 本地安装IK</h3><blockquote>
<p>可以将对应的IK分词器下载到本地,然后再安装 <strong>NOTE: 本课程使用本地安装</strong></p>
</blockquote>
<pre><code class="hljs shell">1. 下载对应版本
	[es@linux ~]$ wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.4/elasticsearch-analysis-ik-6.2.4.zip

2. 解压
	[es@linux ~]$ unzip elasticsearch-analysis-ik-6.2.4.zip #先使用yum install -y unzip

3. 移动到es安装目录的plugins目录中
	[es@linux ~]$ ls elasticsearch-6.2.4/plugins/
	[es@linux ~]$ mv elasticsearch elasticsearch-6.2.4/plugins/
	[es@linux ~]$ ls elasticsearch-6.2.4/plugins/
		elasticsearch
	[es@linux ~]$ ls elasticsearch-6.2.4/plugins/elasticsearch/
		commons-codec-1.9.jar    config                               httpclient-4.5.2.jar  		plugin-descriptor.properties
		commons-logging-1.2.jar  elasticsearch-analysis-ik-6.2.4.jar  httpcore-4.4.4.jar
		
4. 重启es生效</code></pre>

<h3 id="11-3-测试IK分词器"><a href="#11-3-测试IK分词器" class="headerlink" title="11.3 测试IK分词器"></a>11.3 测试IK分词器</h3><blockquote>
<p><strong>NOTE: IK分词器提供了两种mapping类型用来做文档的分词分别是 <code>ik_max_word</code> 和<code> ik_smart</code></strong></p>
<p><code>ik_max_word 和 ik_smart 什么区别?</code></p>
<p>​        <code>ik_max_word: 会将文本做最细粒度的拆分</code>，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合；</p>
<p>​        <code>ik_smart: 会做最粗粒度的拆分</code>，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”。</p>
</blockquote>
<h4 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h4><pre><code class="hljs json">DELETE /ems

PUT /ems
&#123;
  <span class="hljs-attr">&quot;mappings&quot;</span>:&#123;
    <span class="hljs-attr">&quot;emp&quot;</span>:&#123;
      <span class="hljs-attr">&quot;properties&quot;</span>:&#123;
        <span class="hljs-attr">&quot;name&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,
           <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,
           <span class="hljs-attr">&quot;search_analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;age&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;bir&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;date&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;content&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,
          <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,
          <span class="hljs-attr">&quot;search_analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;address&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span>
        &#125;
      &#125;
    &#125;
  &#125;
&#125;



PUT /ems/emp/_bulk
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;小黑&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">23</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;为开发团队选择一款优秀的MVC框架是件难事儿，在众多可行的方案中决择需要很高的经验和水平&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;王小黑&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">24</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Spring 框架是一个分层架构，由 7 个定义良好的模块组成。Spring 模块构建在核心容器之上，核心容器定义了创建、配置和管理 bean 的方式&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;上海&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张小五&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">8</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Spring Cloud 作为Java 语言的微服务框架，它依赖于Spring Boot，有快速开发、持续交付和容易部署等特点。Spring Cloud 的组件非常多，涉及微服务的方方面面，井在开源社区Spring 和Netflix 、Pivotal 两大公司的推动下越来越完善&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;无锡&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;win7&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">9</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Spring的目标是致力于全方位的简化Java开发。 这势必引出更多的解释， Spring是如何简化Java开发的？&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;南京&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;梅超风&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">43</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;杭州&quot;</span>&#125;
  &#123;<span class="hljs-attr">&quot;index&quot;</span>:&#123;&#125;&#125;
  &#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张无忌&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">59</span>,<span class="hljs-attr">&quot;bir&quot;</span>:<span class="hljs-string">&quot;2012-12-12&quot;</span>,<span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口&quot;</span>,<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京&quot;</span>&#125;


GET /ems/emp/_search
&#123;
  <span class="hljs-attr">&quot;query&quot;</span>:&#123;
    <span class="hljs-attr">&quot;term&quot;</span>:&#123;
      <span class="hljs-attr">&quot;content&quot;</span>:<span class="hljs-string">&quot;框架&quot;</span>
    &#125;
  &#125;,
  <span class="hljs-attr">&quot;highlight&quot;</span>: &#123;
    <span class="hljs-attr">&quot;pre_tags&quot;</span>: [<span class="hljs-string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>],
    <span class="hljs-attr">&quot;post_tags&quot;</span>: [<span class="hljs-string">&quot;&lt;/span&gt;&quot;</span>],
    <span class="hljs-attr">&quot;fields&quot;</span>: &#123;
      <span class="hljs-attr">&quot;*&quot;</span>:&#123;&#125;
    &#125;
  &#125;
&#125;</code></pre>



<h3 id="11-4-配置扩展词"><a href="#11-4-配置扩展词" class="headerlink" title="11.4 配置扩展词"></a>11.4 配置扩展词</h3><blockquote>
<p>IK支持自定义<code>扩展词典</code>和<code>停用词典</code>,所谓**<code>扩展词典</code><strong>就是有些词并不是关键词,但是也希望被ES用来作为检索的关键词,可以将这些词加入扩展词典。</strong><code>停用词典</code>**就是有些词是关键词,但是出于业务场景不想使用这些关键词被检索到，可以将这些词放入停用词典。</p>
<p>如何定义扩展词典和停用词典可以修改IK分词器中<code>config</code>目录中<code>IKAnalyzer.cfg.xml</code>这个文件。</p>
<p><strong>NOTE：词典的编码必须为UTF-8，否则无法生效</strong></p>
</blockquote>
<pre><code class="hljs xml">1. 修改vim IKAnalyzer.cfg.xml

    <span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
    <span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">properties</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span>
        <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_dict&quot;</span>&gt;</span>ext_dict.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span>
         <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_stopwords&quot;</span>&gt;</span>ext_stopword.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

2. 在ik分词器目录下config目录中创建ext_dict.dic文件   编码一定要为UTF-8才能生效
	vim ext_dict.dic 加入扩展词即可

3. 在ik分词器目录下config目录中创建ext_stopword.dic文件 
	vim ext_stopword.dic 加入停用词即可

4.重启es生效</code></pre>

<hr>
<h2 id="12-过滤查询-Filter-Query"><a href="#12-过滤查询-Filter-Query" class="headerlink" title="12. (过滤查询) Filter Query"></a>12. (过滤查询) Filter Query</h2><h3 id="12-1-过滤查询"><a href="#12-1-过滤查询" class="headerlink" title="12.1 过滤查询"></a>12.1 过滤查询</h3><blockquote>
<p>其实准确来说，ES中的查询操作分为2种: <code>查询(query)</code>和<code>过滤(filter)</code>。<code>查询即是之前提到的query查询，它 (查询)默认会计算每个返回文档的得分，然后根据得分排序</code>。<code>而过滤(filter)只会筛选出符合的文档，并不计算 得分，且它可以缓存文档 。所以，单从性能考虑，过滤比查询更快</code>。 </p>
<p>换句话说，过滤适合在大范围筛选数据，而查询则适合精确匹配数据。一般应用时， 应先使用过滤操作过滤数据， 然后使用查询匹配数据。 </p>
</blockquote>
<h3 id="12-2-过滤语法"><a href="#12-2-过滤语法" class="headerlink" title="12.2 过滤语法"></a>12.2 过滤语法</h3><pre><code class="hljs json">GET /ems/emp/_search
&#123;
  <span class="hljs-attr">&quot;query&quot;</span>: &#123;
    <span class="hljs-attr">&quot;bool&quot;</span>: &#123;
      <span class="hljs-attr">&quot;must&quot;</span>: [
        &#123;<span class="hljs-attr">&quot;match_all&quot;</span>: &#123;&#125;&#125;
      ],
      <span class="hljs-attr">&quot;filter&quot;</span>: &#123;
        <span class="hljs-attr">&quot;range&quot;</span>: &#123;
          <span class="hljs-attr">&quot;age&quot;</span>: &#123;
            <span class="hljs-attr">&quot;gte&quot;</span>: <span class="hljs-number">10</span>
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<blockquote>
<p><strong>NOTE:  在执行filter和query时,先执行filter在执行query</strong></p>
<p><strong>NOTE:Elasticsearch会自动缓存经常使用的过滤器，以加快性能。</strong></p>
</blockquote>
<h3 id="12-3-常见的过滤器类型"><a href="#12-3-常见的过滤器类型" class="headerlink" title="12.3 常见的过滤器类型"></a>12.3 常见的过滤器类型</h3><h4 id="term-、-terms-Filter"><a href="#term-、-terms-Filter" class="headerlink" title="term 、 terms Filter"></a>term 、 terms Filter</h4><pre><code class="hljs http">GET /ems/emp/_search   # 使用term过滤
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;&quot;term&quot;: &#123;
          &quot;name&quot;: &#123;
            &quot;value&quot;: &quot;小黑&quot;
          &#125;
        &#125;&#125;
      ],
      &quot;filter&quot;: &#123;
        &quot;term&quot;: &#123;
          &quot;content&quot;:&quot;框架&quot;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;
GET /dangdang/book/_search  #使用terms过滤
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;&quot;term&quot;: &#123;
          &quot;name&quot;: &#123;
            &quot;value&quot;: &quot;中国&quot;
          &#125;
        &#125;&#125;
      ],
      &quot;filter&quot;: &#123;
        &quot;terms&quot;: &#123;
          &quot;content&quot;:[
              &quot;科技&quot;,
              &quot;声音&quot;
            ]
        &#125;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="ranage-filter"><a href="#ranage-filter" class="headerlink" title="ranage filter"></a>ranage filter</h4><pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;&quot;term&quot;: &#123;
          &quot;name&quot;: &#123;
            &quot;value&quot;: &quot;中国&quot;
          &#125;
        &#125;&#125;
      ],
      &quot;filter&quot;: &#123;
        &quot;range&quot;: &#123;
          &quot;age&quot;: &#123;
            &quot;gte&quot;: 7,
            &quot;lte&quot;: 20
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="exists-filter"><a href="#exists-filter" class="headerlink" title="exists filter"></a>exists filter</h4><blockquote>
<p><strong>过滤存在指定字段,获取字段不为空的索引记录使用</strong></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;&quot;term&quot;: &#123;
          &quot;name&quot;: &#123;
            &quot;value&quot;: &quot;中国&quot;
          &#125;
        &#125;&#125;
      ],
      &quot;filter&quot;: &#123;
        &quot;exists&quot;: &#123;
          &quot;field&quot;:&quot;aaa&quot;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>



<h4 id="ids-filter"><a href="#ids-filter" class="headerlink" title="ids filter"></a>ids filter</h4><blockquote>
<p><strong>过滤含有指定字段的索引记录</strong></p>
</blockquote>
<pre><code class="hljs http">GET /ems/emp/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;&quot;term&quot;: &#123;
          &quot;name&quot;: &#123;
            &quot;value&quot;: &quot;中国&quot;
          &#125;
        &#125;&#125;
      ],
      &quot;filter&quot;: &#123;
        &quot;ids&quot;: &#123;
          &quot;values&quot;: [&quot;1&quot;,&quot;2&quot;,&quot;3&quot;]
        &#125;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>



<hr>
<h2 id="13-Java操作ES"><a href="#13-Java操作ES" class="headerlink" title="13. Java操作ES"></a>13. Java操作ES</h2><h3 id="13-1-引入maven依赖"><a href="#13-1-引入maven依赖" class="headerlink" title="13.1 引入maven依赖"></a>13.1 引入maven依赖</h3><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>


  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>transport<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>



<h3 id="13-2创建索引和类型"><a href="#13-2创建索引和类型" class="headerlink" title="13.2创建索引和类型"></a>13.2创建索引和类型</h3><h4 id="Rest的创建方式"><a href="#Rest的创建方式" class="headerlink" title="Rest的创建方式"></a>Rest的创建方式</h4><pre><code class="hljs json"><span class="hljs-comment">// 1.在restful的创建方式</span>

PUT /dangdang
&#123;
  <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;
    <span class="hljs-attr">&quot;book&quot;</span>:&#123;
      <span class="hljs-attr">&quot;properties&quot;</span>: &#123;
        <span class="hljs-attr">&quot;name&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,
          <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;age&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;sex&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span>
        &#125;,
        <span class="hljs-attr">&quot;content&quot;</span>:&#123;
          <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,
          <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>
        &#125;
      &#125;
    &#125;
  &#125;
&#125;</code></pre>

<h4 id="Java中创建方式"><a href="#Java中创建方式" class="headerlink" title="Java中创建方式"></a>Java中创建方式</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 创建索引并创建类型同时指定映射</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreateIndexAndTypeAndMapping</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ExecutionException, InterruptedException </span>&#123;
    TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
    
    System.out.println(<span class="hljs-string">&quot;=======创建索引=======&quot;</span>);
    CreateIndexResponse indexResponse = transportClient.admin().indices().prepareCreate(<span class="hljs-string">&quot;dangdang&quot;</span>).execute().get();
    System.out.println(indexResponse.index());

    System.out.println(<span class="hljs-string">&quot;=======创建类型指定映射=======&quot;</span>);
    XContentBuilder mappingBuilder = XContentFactory.jsonBuilder();
    mappingBuilder.startObject()&#123; <span class="hljs-string">&quot;properties&quot;</span>:&#123;<span class="hljs-string">&quot;name&quot;</span>:&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,<span class="hljs-string">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;ik_max_word&quot;</span>&#125;
                                                 <span class="hljs-string">&quot;age&quot;</span>:&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;&quot;</span>
                    .startObject(<span class="hljs-string">&quot;properties&quot;</span>)
                        .startObject(<span class="hljs-string">&quot;name&quot;</span>)
                            .field(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;text&quot;</span>)
                            .field(<span class="hljs-string">&quot;analyzer&quot;</span>, <span class="hljs-string">&quot;ik_max_word&quot;</span>)
                        .endObject()
                        .startObject(<span class="hljs-string">&quot;age&quot;</span>)
                            .field(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;integer&quot;</span>)
                        .endObject()
                        .startObject(<span class="hljs-string">&quot;sex&quot;</span>)
                            .field(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;keyword&quot;</span>)
                        .endObject()
                        .startObject(<span class="hljs-string">&quot;content&quot;</span>)
                            .field(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;text&quot;</span>)
                            .field(<span class="hljs-string">&quot;analyzer&quot;</span>, <span class="hljs-string">&quot;ik_max_word&quot;</span>)
                        .endObject()
                    .endObject()
                .endObject();

    PutMappingRequest putMappingRequest = <span class="hljs-keyword">new</span> PutMappingRequest(<span class="hljs-string">&quot;dangdang&quot;</span>).type(<span class="hljs-string">&quot;book&quot;</span>).source(mappingBuilder);
    transportClient.admin().indices().putMapping(putMappingRequest).get();
&#125;</code></pre>

<h3 id="13-3-索引一条记录"><a href="#13-3-索引一条记录" class="headerlink" title="13.3 索引一条记录"></a>13.3 索引一条记录</h3><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 创建索引(自动生成文档id)</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().startObject()
               .field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;中国人&quot;</span>)
               .field(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-number">23</span>)
               .field(<span class="hljs-string">&quot;sex&quot;</span>,<span class="hljs-string">&quot;男&quot;</span>)
               .field(<span class="hljs-string">&quot;content&quot;</span>,<span class="hljs-string">&quot;他是一个中国人,这个中国人怎么样,挺好的&quot;</span>).endObject();
       IndexResponse indexResponse = transportClient.prepareIndex(<span class="hljs-string">&quot;dangdang&quot;</span>, <span class="hljs-string">&quot;book&quot;</span>).setSource(xContentBuilder).get();
       System.out.println(indexResponse.status());
   &#125;

<span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 创建索引(指定生成文档id)</span>
<span class="hljs-comment">    *</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().startObject()
               .field(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;中国人&quot;</span>)
               .field(<span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-number">23</span>)
               .field(<span class="hljs-string">&quot;sex&quot;</span>, <span class="hljs-string">&quot;男&quot;</span>)
               .field(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;他是一个中国人,这个中国人怎么样,挺好的&quot;</span>).endObject();
       IndexResponse indexResponse = transportClient.prepareIndex(<span class="hljs-string">&quot;dangdang&quot;</span>, <span class="hljs-string">&quot;book&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>).setSource(xContentBuilder).get();
       System.out.println(indexResponse.status());
   &#125;</code></pre>

<h3 id="13-3-更新一条索引"><a href="#13-3-更新一条索引" class="headerlink" title="13.3 更新一条索引"></a>13.3 更新一条索引</h3><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 更新一条记录</span>
<span class="hljs-comment"> *</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUpdate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       XContentBuilder source = XContentFactory.jsonBuilder();
       source.startObject().field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;小黑是中国人&quot;</span>).endObject();
       UpdateResponse updateResponse = transportClient.prepareUpdate(<span class="hljs-string">&quot;dangdang&quot;</span>, <span class="hljs-string">&quot;book&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)
               .setDoc(source).get();
       System.out.println(updateResponse.status());
   &#125;</code></pre>

<h3 id="13-4-删除一条索引"><a href="#13-4-删除一条索引" class="headerlink" title="13.4 删除一条索引"></a>13.4 删除一条索引</h3><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 删除一条索引记录</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> UnknownHostException</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>  <span class="hljs-title">testDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       DeleteResponse deleteResponse = transportClient.prepareDelete(<span class="hljs-string">&quot;dangdang&quot;</span>, <span class="hljs-string">&quot;book&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>).get();
       System.out.println(deleteResponse.status());
   &#125;</code></pre>

<h3 id="13-5-批量更新"><a href="#13-5-批量更新" class="headerlink" title="13.5 批量更新"></a>13.5 批量更新</h3><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 批量更新</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBulk</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));

       <span class="hljs-comment">//添加第一条记录</span>
       IndexRequest request1 = <span class="hljs-keyword">new</span> IndexRequest(<span class="hljs-string">&quot;dangdang&quot;</span>,<span class="hljs-string">&quot;book&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);
       request1.source(XContentFactory.jsonBuilder().startObject().field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;中国科技&quot;</span>).field(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-number">23</span>).field(<span class="hljs-string">&quot;sex&quot;</span>,<span class="hljs-string">&quot;男&quot;</span>).field(<span class="hljs-string">&quot;content&quot;</span>,<span class="hljs-string">&quot;这是个好人&quot;</span>).endObject());


       <span class="hljs-comment">//添加第二条记录</span>
       IndexRequest request2 = <span class="hljs-keyword">new</span> IndexRequest(<span class="hljs-string">&quot;dangdang&quot;</span>,<span class="hljs-string">&quot;book&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>);
       request2.source(XContentFactory.jsonBuilder().startObject().field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;中国之声&quot;</span>).field(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-number">23</span>).field(<span class="hljs-string">&quot;sex&quot;</span>,<span class="hljs-string">&quot;男&quot;</span>).field(<span class="hljs-string">&quot;content&quot;</span>,<span class="hljs-string">&quot;这是一个好的声音&quot;</span>).endObject());

       <span class="hljs-comment">//更新记录</span>
       UpdateRequest updateRequest = <span class="hljs-keyword">new</span> UpdateRequest(<span class="hljs-string">&quot;dangdang&quot;</span>,<span class="hljs-string">&quot;book&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);
       updateRequest.doc(XContentFactory.jsonBuilder().startObject().field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;中国力量&quot;</span>).endObject());

       <span class="hljs-comment">//删除一条记录</span>
       DeleteRequest deleteRequest = <span class="hljs-keyword">new</span> DeleteRequest(<span class="hljs-string">&quot;dangdang&quot;</span>,<span class="hljs-string">&quot;book&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);

       BulkResponse bulkItemResponses = transportClient.prepareBulk().add(request1).add(request2).add(updateRequest).add(deleteRequest).get();
       BulkItemResponse[] items = bulkItemResponses.getItems();
       <span class="hljs-keyword">for</span> (BulkItemResponse item : items) &#123;
           System.out.println(item.status());
       &#125;

   &#125;</code></pre>

<h3 id="13-6-检索记录"><a href="#13-6-检索记录" class="headerlink" title="13.6 检索记录"></a>13.6 检索记录</h3><h4 id="查询所有并排序"><a href="#查询所有并排序" class="headerlink" title="查询所有并排序"></a>查询所有并排序</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询所有并排序</span>
<span class="hljs-comment">     *  ASC 升序  DESC 降序</span>
<span class="hljs-comment">     *  addSort(&quot;age&quot;, SortOrder.ASC)  指定排序字段以及使用哪种方式排序</span>
<span class="hljs-comment">     *  addSort(&quot;age&quot;, SortOrder.DESC) 指定排序字段以及使用哪种方式排序</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMatchAllQuery</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
        TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
        SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(QueryBuilders.matchAllQuery()).addSort(<span class="hljs-string">&quot;age&quot;</span>, SortOrder.DESC).get();
        SearchHits hits = searchResponse.getHits();
        System.out.println(<span class="hljs-string">&quot;符合条件的记录数: &quot;</span>+hits.totalHits);
        <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;
            System.out.print(<span class="hljs-string">&quot;当前索引的分数: &quot;</span>+hit.getScore());
            System.out.print(<span class="hljs-string">&quot;, 对应结果:=====&gt;&quot;</span>+hit.getSourceAsString());
            System.out.println(<span class="hljs-string">&quot;, 指定字段结果:&quot;</span>+hit.getSourceAsMap().get(<span class="hljs-string">&quot;name&quot;</span>));
            System.out.println(<span class="hljs-string">&quot;=================================================&quot;</span>);
        &#125;
    &#125;</code></pre>

<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 分页查询</span>
<span class="hljs-comment">    *  From 从那条记录开始 默认从0 开始  form = (pageNow-1)*size</span>
<span class="hljs-comment">    *  Size 每次返回多少条符合条件的结果  默认10</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMatchAllQueryFormAndSize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(QueryBuilders.matchAllQuery()).setFrom(<span class="hljs-number">0</span>).setSize(<span class="hljs-number">2</span>).get();
       SearchHits hits = searchResponse.getHits();
       System.out.println(<span class="hljs-string">&quot;符合条件的记录数: &quot;</span>+hits.totalHits);
       <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;
           System.out.print(<span class="hljs-string">&quot;当前索引的分数: &quot;</span>+hit.getScore());
           System.out.print(<span class="hljs-string">&quot;, 对应结果:=====&gt;&quot;</span>+hit.getSourceAsString());
           System.out.println(<span class="hljs-string">&quot;, 指定字段结果:&quot;</span>+hit.getSourceAsMap().get(<span class="hljs-string">&quot;name&quot;</span>));
           System.out.println(<span class="hljs-string">&quot;=================================================&quot;</span>);
       &#125;
   &#125;</code></pre>

<h4 id="查询返回字段"><a href="#查询返回字段" class="headerlink" title="查询返回字段"></a>查询返回字段</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    *  查询返回指定字段(source) 默认返回所有</span>
<span class="hljs-comment">    *      setFetchSource 参数1:包含哪些字段   参数2:排除哪些字段</span>
<span class="hljs-comment">    *      setFetchSource(&quot;*&quot;,&quot;age&quot;)  返回所有字段中排除age字段</span>
<span class="hljs-comment">    *      setFetchSource(&quot;name&quot;,&quot;&quot;)  只返回name字段</span>
<span class="hljs-comment">    *      setFetchSource(new String[]&#123;&#125;,new String[]&#123;&#125;)</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMatchAllQuerySource</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(QueryBuilders.matchAllQuery()).setFetchSource(<span class="hljs-string">&quot;*&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>).get();
       SearchHits hits = searchResponse.getHits();
       System.out.println(<span class="hljs-string">&quot;符合条件的记录数: &quot;</span>+hits.totalHits);
       <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;
           System.out.print(<span class="hljs-string">&quot;当前索引的分数: &quot;</span>+hit.getScore());
           System.out.print(<span class="hljs-string">&quot;, 对应结果:=====&gt;&quot;</span>+hit.getSourceAsString());
           System.out.println(<span class="hljs-string">&quot;, 指定字段结果:&quot;</span>+hit.getSourceAsMap().get(<span class="hljs-string">&quot;name&quot;</span>));
           System.out.println(<span class="hljs-string">&quot;=================================================&quot;</span>);
       &#125;
   &#125;</code></pre>

<h4 id="term查询"><a href="#term查询" class="headerlink" title="term查询"></a>term查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    *  term查询</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTerm</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       TermQueryBuilder queryBuilder = QueryBuilders.termQuery(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;中国&quot;</span>);
       SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(queryBuilder).get();
   &#125;</code></pre>

<h4 id="range查询"><a href="#range查询" class="headerlink" title="range查询"></a>range查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    *  rang查询</span>
<span class="hljs-comment">    *     lt    小于</span>
<span class="hljs-comment">    *     lte   小于等于</span>
<span class="hljs-comment">    *     gt    大于</span>
<span class="hljs-comment">    *     gte   大于等于</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRange</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery(<span class="hljs-string">&quot;age&quot;</span>).lt(<span class="hljs-number">45</span>).gte(<span class="hljs-number">8</span>);
       SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(rangeQueryBuilder).get();
 	&#125;</code></pre>

<h4 id="prefix查询"><a href="#prefix查询" class="headerlink" title="prefix查询"></a>prefix查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">   *  prefix 前缀查询</span>
<span class="hljs-comment">   *</span>
<span class="hljs-comment">   */</span>
  <span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPrefix</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
      TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
      PrefixQueryBuilder prefixQueryBuilder = QueryBuilders.prefixQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;中&quot;</span>);
      SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(prefixQueryBuilder).get();
  &#125;</code></pre>

<h4 id="wildcard查询"><a href="#wildcard查询" class="headerlink" title="wildcard查询"></a>wildcard查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    *  wildcardQuery 通配符查询</span>
<span class="hljs-comment">    *</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testwildcardQuery</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       WildcardQueryBuilder wildcardQueryBuilder = QueryBuilders.wildcardQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;中*&quot;</span>);
       SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(wildcardQueryBuilder).get();
   &#125;</code></pre>

<h4 id="Ids查询"><a href="#Ids查询" class="headerlink" title="Ids查询"></a>Ids查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * ids 查询</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIds</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
       TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
       IdsQueryBuilder idsQueryBuilder = QueryBuilders.idsQuery().addIds(<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>);
       SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(idsQueryBuilder).get();
   &#125;</code></pre>

<h4 id="fuzzy模糊查询"><a href="#fuzzy模糊查询" class="headerlink" title="fuzzy模糊查询"></a>fuzzy模糊查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">  * fuzzy 查询</span>
<span class="hljs-comment">  */</span>
 <span class="hljs-meta">@Test</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFuzzy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
     TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
     FuzzyQueryBuilder fuzzyQueryBuilder = QueryBuilders.fuzzyQuery(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;国人&quot;</span>);
     SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(fuzzyQueryBuilder).get();
 &#125;</code></pre>

<h4 id="bool-查询"><a href="#bool-查询" class="headerlink" title="bool 查询"></a>bool 查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">  * bool 查询</span>
<span class="hljs-comment">  */</span>
 <span class="hljs-meta">@Test</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
     TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
     BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
         boolQueryBuilder.should(QueryBuilders.matchAllQuery());
         boolQueryBuilder.mustNot(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;age&quot;</span>).lte(<span class="hljs-number">8</span>));
         boolQueryBuilder.must(QueryBuilders.termQuery(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;中国&quot;</span>));
     SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).setQuery(boolQueryBuilder).get();
 &#125;</code></pre>

<h4 id="高亮查询"><a href="#高亮查询" class="headerlink" title="高亮查询"></a>高亮查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 高亮查询</span>
<span class="hljs-comment">     *  .highlighter(highlightBuilder) 用来指定高亮设置</span>
<span class="hljs-comment">     *  requireFieldMatch(false) 开启多个字段高亮</span>
<span class="hljs-comment">     *  field 用来定义高亮字段</span>
<span class="hljs-comment">     *  preTags(&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;)  用来指定高亮前缀</span>
<span class="hljs-comment">     *  postTags(&quot;&lt;/span&gt;&quot;) 用来指定高亮后缀</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHighlight</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>&#123;
        TransportClient transportClient = <span class="hljs-keyword">new</span> PreBuiltTransportClient(Settings.EMPTY).addTransportAddress(<span class="hljs-keyword">new</span> TransportAddress(InetAddress.getByName(<span class="hljs-string">&quot;172.16.251.142&quot;</span>), <span class="hljs-number">9300</span>));
        TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;中国&quot;</span>);

        HighlightBuilder highlightBuilder = <span class="hljs-keyword">new</span> HighlightBuilder();

        highlightBuilder.requireFieldMatch(<span class="hljs-keyword">false</span>).field(<span class="hljs-string">&quot;name&quot;</span>).field(<span class="hljs-string">&quot;content&quot;</span>).preTags(<span class="hljs-string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>).postTags(<span class="hljs-string">&quot;&lt;/span&gt;&quot;</span>);

        SearchResponse searchResponse = transportClient.prepareSearch(<span class="hljs-string">&quot;dangdang&quot;</span>).setTypes(<span class="hljs-string">&quot;book&quot;</span>).highlighter(highlightBuilder).highlighter(highlightBuilder).setQuery(termQueryBuilder).get();
        SearchHits hits = searchResponse.getHits();
        System.out.println(<span class="hljs-string">&quot;符合条件的记录数: &quot;</span>+hits.totalHits);
        <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;
            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();
            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();
            System.out.println(<span class="hljs-string">&quot;================高亮之前==========&quot;</span>);
            <span class="hljs-keyword">for</span>(Map.Entry&lt;String,Object&gt; entry:sourceAsMap.entrySet())&#123;
                System.out.println(<span class="hljs-string">&quot;key: &quot;</span>+entry.getKey() +<span class="hljs-string">&quot;   value: &quot;</span>+entry.getValue());
            &#125;
            System.out.println(<span class="hljs-string">&quot;================高亮之后==========&quot;</span>);
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String,Object&gt; entry:sourceAsMap.entrySet())&#123;
                HighlightField highlightField = highlightFields.get(entry.getKey());
                <span class="hljs-keyword">if</span> (highlightField!=<span class="hljs-keyword">null</span>)&#123;
                    System.out.println(<span class="hljs-string">&quot;key: &quot;</span>+entry.getKey() +<span class="hljs-string">&quot;   value: &quot;</span>+ highlightField.fragments()[<span class="hljs-number">0</span>]);

                &#125;<span class="hljs-keyword">else</span>&#123;
                    System.out.println(<span class="hljs-string">&quot;key: &quot;</span>+entry.getKey() +<span class="hljs-string">&quot;   value: &quot;</span>+entry.getValue());
                &#125;
            &#125;

        &#125;
    &#125;</code></pre>

<h4 id="多字段查询"><a href="#多字段查询" class="headerlink" title="多字段查询"></a>多字段查询</h4><pre><code class="hljs java">MultiMatchQueryBuilder queryBuilder 
	= QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;框架&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>);</code></pre>

<h4 id="多字段分词查询"><a href="#多字段分词查询" class="headerlink" title="多字段分词查询"></a>多字段分词查询</h4><pre><code class="hljs java">QueryStringQueryBuilder queryStringQueryBuilder = 
    QueryBuilders.queryStringQuery(<span class="hljs-string">&quot;框架张无忌&quot;</span>)
    .analyzer(<span class="hljs-string">&quot;ik_max_word&quot;</span>) <span class="hljs-comment">//定义分词器</span>
    .field(<span class="hljs-string">&quot;name&quot;</span>)<span class="hljs-comment">//定义字段</span>
    .field(<span class="hljs-string">&quot;content&quot;</span>);<span class="hljs-comment">//字段</span></code></pre>

<hr>
<h3 id="14-SpringBoot-Data操作ES"><a href="#14-SpringBoot-Data操作ES" class="headerlink" title="14. SpringBoot Data操作ES"></a>14. SpringBoot Data操作ES</h3><h4 id="14-1-引入依赖"><a href="#14-1-引入依赖" class="headerlink" title="14.1 引入依赖"></a>14.1 引入依赖</h4><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--注意:升级原有项目中springboot版本--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-comment">&lt;!--springboot web --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!--通过spring data 操作Es--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!--springboot 继承test--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--引入lombook--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.16.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>

<h4 id="14-2-编写yml配置"><a href="#14-2-编写yml配置" class="headerlink" title="14.2 编写yml配置"></a>14.2 编写yml配置</h4><pre><code class="hljs yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">elasticsearch:</span>
      <span class="hljs-attr">cluster-nodes:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.251</span><span class="hljs-number">.142</span><span class="hljs-string">:9300</span></code></pre>

<h4 id="14-3-编写entity"><a href="#14-3-编写entity" class="headerlink" title="14.3 编写entity"></a>14.3 编写entity</h4><pre><code class="hljs java"><span class="hljs-meta">@Document(indexName = &quot;dangdang&quot;,type = &quot;book&quot;)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> </span>&#123;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-meta">@Field(type = FieldType.Text,analyzer =&quot;ik_max_word&quot;)</span>
    <span class="hljs-keyword">private</span> String name;


    <span class="hljs-meta">@Field(type = FieldType.Date)</span>
    <span class="hljs-keyword">private</span> Date createDate;

    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span>
    <span class="hljs-keyword">private</span> String author;

    <span class="hljs-meta">@Field(type = FieldType.Text,analyzer =&quot;ik_max_word&quot;)</span>
    <span class="hljs-keyword">private</span> String content;
&#125;</code></pre>

<blockquote>
<p><code>@Document</code>: 代表一个文档记录 </p>
<p>​    <code>indexName</code>:  用来指定索引名称</p>
<p>​    <code>type</code>:        用来指定索引类型</p>
<p><code>@Id</code>: 用来将对象中id和ES中_id映射</p>
<p><code>@Field</code>: 用来指定ES中的字段对应Mapping</p>
<p>​    <code>type</code>: 用来指定ES中存储类型</p>
<p>​    <code>analyzer</code>: 用来指定使用哪种分词器</p>
</blockquote>
<h4 id="14-4-编写BookRepository"><a href="#14-4-编写BookRepository" class="headerlink" title="14.4 编写BookRepository"></a>14.4 编写BookRepository</h4><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BookRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ElasticsearchRepository</span>&lt;<span class="hljs-title">Book</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
&#125;</code></pre>

<h4 id="14-5-索引or更新一条记录"><a href="#14-5-索引or更新一条记录" class="headerlink" title="14.5 索引or更新一条记录"></a>14.5 索引or更新一条记录</h4><blockquote>
<p><strong>NOTE:这种方式根据实体类中中配置自动在ES创建索引,类型以及映射</strong></p>
</blockquote>
<pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest(classes = Application.class)</span>
<span class="hljs-meta">@RunWith(SpringRunner.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSpringBootDataEs</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BookRepository bookRespistory;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 添加索引和更新索引 id 存在更新 不存在添加</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSaveOrUpdate</span><span class="hljs-params">()</span></span>&#123;
        Book book = <span class="hljs-keyword">new</span> Book();
        book.setId(<span class="hljs-string">&quot;21&quot;</span>);
        book.setName(<span class="hljs-string">&quot;小陈&quot;</span>);
        book.setCreateDate(<span class="hljs-keyword">new</span> Date());
        book.setAuthor(<span class="hljs-string">&quot;李白&quot;</span>);
        book.setContent(<span class="hljs-string">&quot;这是中国的好人,这真的是一个很好的人,李白很狂&quot;</span>);
        bookRespistory.save(book);
    &#125;
&#125;</code></pre>

<h4 id="14-6-删除一条记录"><a href="#14-6-删除一条记录" class="headerlink" title="14.6 删除一条记录"></a>14.6 删除一条记录</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 删除一条索引</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelete</span><span class="hljs-params">()</span></span>&#123;
    Book book = <span class="hljs-keyword">new</span> Book();
    book.setId(<span class="hljs-string">&quot;21&quot;</span>);
    bookRespistory.delete(book);
&#125;</code></pre>

<h4 id="14-7-查询"><a href="#14-7-查询" class="headerlink" title="14.7 查询"></a>14.7 查询</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 查询所有</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindAll</span><span class="hljs-params">()</span></span>&#123;
    Iterable&lt;Book&gt; books = bookRespistory.findAll();
    <span class="hljs-keyword">for</span> (Book book : books) &#123;
        System.out.println(book);
    &#125;
&#125;


<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 查询一个</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindOne</span><span class="hljs-params">()</span></span>&#123;
    Optional&lt;Book&gt; byId = bookRespistory.findById(<span class="hljs-string">&quot;21&quot;</span>);
    System.out.println(byId.get());
&#125;</code></pre>

<h4 id="14-8-查询排序"><a href="#14-8-查询排序" class="headerlink" title="14.8 查询排序"></a>14.8 查询排序</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 排序查询</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindAllOrder</span><span class="hljs-params">()</span></span>&#123;
       Iterable&lt;Book&gt; books = bookRespistory.findAll(Sort.by(Sort.Order.asc(<span class="hljs-string">&quot;createDate&quot;</span>)));
       books.forEach(book -&gt; System.out.println(book) );
   &#125;</code></pre>

<h4 id="14-9-自定义基本查询"><a href="#14-9-自定义基本查询" class="headerlink" title="14.9 自定义基本查询"></a>14.9 自定义基本查询</h4><table>
<thead>
<tr>
<th>Keyword</th>
<th>Sample</th>
<th>Elasticsearch Query String</th>
</tr>
</thead>
<tbody><tr>
<td><code>And</code></td>
<td><code>findByNameAndPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Or</code></td>
<td><code>findByNameOrPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Is</code></td>
<td><code>findByName</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Not</code></td>
<td><code>findByNameNot</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Between</code></td>
<td><code>findByPriceBetween</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>LessThanEqual</code></td>
<td><code>findByPriceLessThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>GreaterThanEqual</code></td>
<td><code>findByPriceGreaterThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Before</code></td>
<td><code>findByPriceBefore</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>After</code></td>
<td><code>findByPriceAfter</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Like</code></td>
<td><code>findByNameLike</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>StartingWith</code></td>
<td><code>findByNameStartingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>EndingWith</code></td>
<td><code>findByNameEndingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;*?&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Contains/Containing</code></td>
<td><code>findByNameContaining</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;**?**&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>In</code></td>
<td><code>findByNameIn</code><br><code>(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>NotIn</code></td>
<td><code>findByNameNotIn</code><br/><code>(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Near</code></td>
<td><code>findByStoreNear</code></td>
<td><code>Not Supported Yet !</code></td>
</tr>
<tr>
<td><code>True</code></td>
<td><code>findByAvailableTrue</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>False</code></td>
<td><code>findByAvailableFalse</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : false&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>OrderBy</code></td>
<td><code>findByAvailable</code><br><code>TrueOrderByNameDesc</code></td>
<td><code>&#123;&quot;sort&quot; : [&#123; &quot;name&quot; : &#123;&quot;order&quot; : &quot;desc&quot;&#125; &#125;],&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
</tbody></table>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BookRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ElasticsearchRepository</span>&lt;<span class="hljs-title">Book</span>,<span class="hljs-title">String</span>&gt; </span>&#123;

    <span class="hljs-comment">//根据作者查询</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByAuthor</span><span class="hljs-params">(String keyword)</span></span>;

    <span class="hljs-comment">//根据内容查询</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByContent</span><span class="hljs-params">(String keyword)</span></span>;

    <span class="hljs-comment">//根据内容和名字查</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByNameAndContent</span><span class="hljs-params">(String name,String content)</span></span>;

    <span class="hljs-comment">//根据内容或名称查询</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByNameOrContent</span><span class="hljs-params">(String name,String content)</span></span>;

    <span class="hljs-comment">//范围查询</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByPriceBetween</span><span class="hljs-params">(Double start,Double end)</span></span>;

    <span class="hljs-comment">//查询名字以xx开始的</span>
    <span class="hljs-function">List&lt;Book&gt;  <span class="hljs-title">findByNameStartingWith</span><span class="hljs-params">(String name)</span></span>;

    <span class="hljs-comment">//查询某个字段值是否为false</span>
    <span class="hljs-function">List&lt;Book&gt;  <span class="hljs-title">findByNameFalse</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">//.......</span>
&#125;</code></pre>

<h4 id="14-10-实现复杂查询"><a href="#14-10-实现复杂查询" class="headerlink" title="14.10 实现复杂查询"></a>14.10 实现复杂查询</h4><h5 id="自定义接口"><a href="#自定义接口" class="headerlink" title="自定义接口"></a>自定义接口</h5><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CustomerBookRepository</span>  </span>&#123;

    <span class="hljs-comment">//实现分页的方法</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByPageable</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page,<span class="hljs-keyword">int</span> size)</span></span>;
    <span class="hljs-comment">//term查询高亮</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">findByNameAndHighlightAdnPageable</span><span class="hljs-params">(String name,<span class="hljs-keyword">int</span> page,<span class="hljs-keyword">int</span> size,String filter)</span></span>;

&#125;
</code></pre>

<h5 id="自定义实现"><a href="#自定义实现" class="headerlink" title="自定义实现"></a>自定义实现</h5><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.baizhi.es.dao;

<span class="hljs-keyword">import</span> com.baizhi.es.entity.Book;
<span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchResponse;
<span class="hljs-keyword">import</span> org.elasticsearch.index.query.QueryBuilders;
<span class="hljs-keyword">import</span> org.elasticsearch.search.SearchHit;
<span class="hljs-keyword">import</span> org.elasticsearch.search.SearchHits;
<span class="hljs-keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;
<span class="hljs-keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightField;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.domain.PageRequest;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Pageable;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.SearchResultMapper;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.aggregation.AggregatedPage;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.aggregation.impl.AggregatedPageImpl;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQuery;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.elasticsearch.index.query.QueryBuilders.*;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerBookRepositoryImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CustomerBookRepository</span></span>&#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title">findByNameAndHighlightAdnPageable</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size,String filter)</span> </span>&#123;


        HighlightBuilder.Field nameField = <span class="hljs-keyword">new</span> HighlightBuilder
                .Field(<span class="hljs-string">&quot;*&quot;</span>)
                .preTags(<span class="hljs-string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>)
                .postTags(<span class="hljs-string">&quot;&lt;/span&gt;&quot;</span>).requireFieldMatch(<span class="hljs-keyword">false</span>);


        NativeSearchQuery nativeSearchQuery = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder()

                .withQuery(QueryBuilders.multiMatchQuery(name,<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>))
                .withPageable(PageRequest.of(page,size))
                .withHighlightFields(nameField)
                .withFilter(boolQuery().mustNot(termQuery(<span class="hljs-string">&quot;name&quot;</span>,filter)))
                .build();

        AggregatedPage&lt;Book&gt; books = elasticsearchTemplate.queryForPage(nativeSearchQuery, Book.class, <span class="hljs-keyword">new</span> SearchResultMapper() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">AggregatedPage&lt;T&gt; <span class="hljs-title">mapResults</span><span class="hljs-params">(SearchResponse response, Class&lt;T&gt; clazz, Pageable pageable)</span> </span>&#123;
                SearchHits searchHits = response.getHits();
                SearchHit[] hits = searchHits.getHits();
                ArrayList&lt;Book&gt; books = <span class="hljs-keyword">new</span> ArrayList&lt;Book&gt;();
                <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;
                    Book book = <span class="hljs-keyword">new</span> Book();
                    <span class="hljs-comment">//原始map</span>
                    Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();
                    book.setId(sourceAsMap.get(<span class="hljs-string">&quot;id&quot;</span>).toString());
                    book.setAuthor(sourceAsMap.get(<span class="hljs-string">&quot;author&quot;</span>).toString());
       book.setPrice(Double.parseDouble(sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>).toString()));
book.setCreateDate(<span class="hljs-keyword">new</span> Date(Long.valueOf(sourceAsMap.get(<span class="hljs-string">&quot;createDate&quot;</span>).toString())));
                    book.setName(sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>).toString());
                    book.setContent(sourceAsMap.get(<span class="hljs-string">&quot;content&quot;</span>).toString());

                    <span class="hljs-comment">//高亮</span>
                    Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();
                    System.out.println(highlightFields);
                    <span class="hljs-keyword">if</span> (highlightFields.get(<span class="hljs-string">&quot;name&quot;</span>) != <span class="hljs-keyword">null</span>) &#123;
                        String nameHighlight = highlightFields.get(<span class="hljs-string">&quot;name&quot;</span>).getFragments()[<span class="hljs-number">0</span>].toString();
                        book.setName(nameHighlight);
                    &#125;
                    <span class="hljs-keyword">if</span> (highlightFields.get(<span class="hljs-string">&quot;content&quot;</span>) != <span class="hljs-keyword">null</span>) &#123;
                        String contentHighlight = highlightFields.get(<span class="hljs-string">&quot;content&quot;</span>).getFragments()[<span class="hljs-number">0</span>].toString();
                        book.setContent(contentHighlight);
                    &#125;
                    books.add(book);
                &#125;
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AggregatedPageImpl&lt;T&gt;((List&lt;T&gt;)books);
            &#125;
        &#125;);
        <span class="hljs-keyword">return</span> books.getContent();
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title">findByPageable</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size)</span> </span>&#123;
        NativeSearchQuery searchQuery = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder()
                .withIndices(<span class="hljs-string">&quot;dangdang&quot;</span>)
                .withTypes(<span class="hljs-string">&quot;book&quot;</span>)
                .withQuery(matchAllQuery())
                .withPageable(PageRequest.of(page,size))
                .build();
        <span class="hljs-keyword">return</span> elasticsearchTemplate.queryForList(searchQuery,Book.class);
    &#125;
&#125;</code></pre>



<hr>
<h2 id="15-ES中集群"><a href="#15-ES中集群" class="headerlink" title="15. ES中集群"></a>15. ES中集群</h2><h3 id="15-1-相关概念"><a href="#15-1-相关概念" class="headerlink" title="15.1 相关概念"></a>15.1 相关概念</h3><h4 id="集群-cluster"><a href="#集群-cluster" class="headerlink" title="集群(cluster)"></a>集群(cluster)</h4><blockquote>
<p>一个集群就是由一个或多个节点组织在一起，它们共同持有你整个的数据，并一起提供索引和搜索功能。一个集群 由一个唯一的名字标识，这个名字默认就是<code>elasticsearch</code>。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群。在产品环境中显式地设定这个名字是一个好习惯，但是使用默认值来进行测试/开发也是不错的。 </p>
</blockquote>
<h4 id="节点-node"><a href="#节点-node" class="headerlink" title="节点(node)"></a>节点(node)</h4><blockquote>
<p>一个节点是你集群中的一个服务器，作为集群的一部分，它存储你的数据，参与集群的索引和搜索功能。和集群类似，一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对应于Elasticsearch集群中的哪些节点。 </p>
</blockquote>
<blockquote>
<p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫 做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。 </p>
</blockquote>
<blockquote>
<p>在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何Elasticsearch节点， 这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。 </p>
</blockquote>
<h4 id="分片和复制-shards-amp-replicas"><a href="#分片和复制-shards-amp-replicas" class="headerlink" title="分片和复制(shards &amp; replicas)"></a>分片和复制(shards &amp; replicas)</h4><blockquote>
<p>一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间;或者单个节点处理搜索请求，响应太慢。为了解决这个问题，Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置 到集群中的任何节点上。 分片之所以重要，主要有两方面的原因: </p>
</blockquote>
<blockquote>
<p>允许你水平分割/扩展你的内容容量允许你在分片(潜在地，位于多个节点上)之上进行分布式的、并行的操作，进而提高性能/吞吐量 至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说，这些都是透明的。 </p>
</blockquote>
<blockquote>
<p>在一个网络/云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了。这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。复制之所以重要，主要有两方面的原因: </p>
</blockquote>
<blockquote>
<p> 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要 (original/primary)分片置于同一节点上是非常重要的。 扩展你的搜索量/吞吐量，因为搜索可以在所有的复制上并行运行 </p>
</blockquote>
<blockquote>
<p>总之，每个索引可以被分成多个分片。一个索引也可以被复制0次(意思是没有复制)或多次。一旦复制了，每个 索引就有了主分片(作为复制源的原来的分片)和复制分片(主分片的拷贝)之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制数量，但是不能改变分片的数量。 </p>
</blockquote>
<blockquote>
<p>默认情况下，<code>Elasticsearch中的每个索引被分片5个主分片和1个复制</code>，这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片(1个完全拷贝)，这样的话每个索引总共就有10个分片。一个索引的多个分片可以存放在集群中的一台主机上，也可以存放在多台主机上，这取决于你的集群机器数量。主分片和复制分片的具体位置是由ES内在的策略所决定的。 </p>
</blockquote>
<h3 id="15-2-快速搭建集群"><a href="#15-2-快速搭建集群" class="headerlink" title="15.2 快速搭建集群"></a>15.2 快速搭建集群</h3><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 将原有ES安装包复制三份
<span class="hljs-code">	cp -r elasticsearch-6.2.4/ master/</span>
<span class="hljs-code">	cp -r elasticsearch-6.2.4/ slave1/</span>
<span class="hljs-code">	cp -r elasticsearch-6.2.4/ slave2/</span>
<span class="hljs-code">	</span>
<span class="hljs-code">2. 删除复制目录中data目录 </span>
<span class="hljs-code">	#注意:由于复制目录之前使用过因此需要在创建集群时将原来数据删除</span>
<span class="hljs-code">	rm -rf master/data</span>
<span class="hljs-code">	rm -rf slave1/data</span>
<span class="hljs-code">	rm -rf slave2/data</span>
<span class="hljs-code">	</span>
<span class="hljs-code">3. 编辑没有文件夹中config目录中jvm.options文件跳转启动内存</span>
<span class="hljs-code">	vim master/config/jvm.options  </span>
<span class="hljs-code">	vim slave1/config/jvm.options</span>
<span class="hljs-code">	vim slave2/config/jvm.options</span>
<span class="hljs-code">	#分别加入: -Xms512m -Xmx512m</span>
<span class="hljs-code">	</span>
<span class="hljs-code">4. 分别修改三个文件夹中config目录中elasticsearch.yml文件</span>
<span class="hljs-code">	vim master/config/elasticsearch.yml</span>
<span class="hljs-code">	vim salve1/config/elasticsearch.yml</span>
<span class="hljs-code">	vim slave2/config/elasticsearch.yml</span>
<span class="hljs-code">	#分别修改如下配置:</span>
<span class="hljs-code">		cluster.name: my-es                       #集群名称(集群名称必须一致)</span>
<span class="hljs-code">		node.name: es-03                          #节点名称(节点名称不能一致)</span>
<span class="hljs-code">		network.host: 0.0.0.0                     #监听地址(必须开启远程权限,并关闭防火墙)</span>
<span class="hljs-code">		http.port: 9200                           #监听端口(在一台机器时服务端口不能一致)</span>
<span class="hljs-code">		discovery.zen.ping.unicast.hosts: [&quot;172.30.2.175:9301&quot;, &quot;172.30.2.201:9302&quot;] #另外两个节点的ip</span>
<span class="hljs-code">		gateway.recover_after_nodes: 3            #集群可做master的最小节点数</span>
<span class="hljs-code">		transport.tcp.port: 9300				  #集群TCP端口(在一台机器搭建必须修改)</span>
<span class="hljs-code">5.	启动多个es</span>
<span class="hljs-code">	./master/bin/elasticsearch</span>
<span class="hljs-code">	./slave1/bin/elasticsearch</span>
<span class="hljs-code">	./slave2/bin/elasticsearch</span>
<span class="hljs-code">	</span>
<span class="hljs-code">6. 查看节点状态</span>
<span class="hljs-code">	curl  http://10.102.115.3:9200</span>
<span class="hljs-code">	curl  http://10.102.115.3:8200</span>
<span class="hljs-code">	curl  http://10.102.115.3:7200</span>
<span class="hljs-code"></span>
<span class="hljs-code">7. 查看集群健康</span>
<span class="hljs-code">	http://10.102.115.3:9200/_cat/health?v</span></code></pre>

<h3 id="15-3-安装head插件"><a href="#15-3-安装head插件" class="headerlink" title="15.3 安装head插件"></a>15.3 安装head插件</h3><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 访问github网站
<span class="hljs-code">	搜索: elasticsearch-head 插件</span>
<span class="hljs-code">	</span>
<span class="hljs-code">2. 安装git</span>
<span class="hljs-code">	yum install git</span>
<span class="hljs-code">	</span>
<span class="hljs-code">3. 将elasticsearch-head下载到本地</span>
<span class="hljs-code">	git clone git://github.com/mobz/elasticsearch-head.git</span>
<span class="hljs-code"></span>
<span class="hljs-code">4. 安装nodejs</span>
<span class="hljs-code">	#注意: 没有wget的请先安装yum install -y wget</span>
<span class="hljs-code">	wget http://cdn.npm.taobao.org/dist/node/latest-v8.x/node-v8.1.2-linux-x64.tar.xz</span>
<span class="hljs-code"></span>
<span class="hljs-code">5. 解压缩nodejs</span>
<span class="hljs-code">	xz -d node-v10.15.3-linux-arm64.tar.xz</span>
<span class="hljs-code">	tar -xvf node-v10.15.3-linux-arm64.tar</span>
<span class="hljs-code"></span>
<span class="hljs-code">6. 配置环境变量</span>
<span class="hljs-code">	mv node-v10.15.3-linux-arm64 nodejs</span>
<span class="hljs-code">	mv nodejs /usr/nodejs</span>
<span class="hljs-code">	vim /etc/profile</span>
<span class="hljs-code">		export NODE_HOME=/usr/nodejs</span>
<span class="hljs-code">		export PATH=$PATH:$JAVA_HOME/bin:$NODE_HOME/bin</span>
<span class="hljs-code">	source /etc/profile</span>
<span class="hljs-code">7.	进入elasticsearch-head的目录</span>
<span class="hljs-code">	npm config set registry https://registry.npm.taobao.org</span>
<span class="hljs-code">	npm install</span>
<span class="hljs-code">	npm run start</span>
<span class="hljs-code"></span>
<span class="hljs-code">8.  编写elastsearch.yml配置文件开启head插件的访问</span>
<span class="hljs-code">	http.cors.enabled: true</span>
<span class="hljs-code">	http.cors.allow-origin: &quot;*&quot;</span>
<span class="hljs-code"></span>
<span class="hljs-code">9.  启动访问head插件 默认端口9100</span>
<span class="hljs-code">	http://ip:9100  查看集群状态</span></code></pre>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/07/JWT%E5%AE%9E%E6%88%98/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JWT实战</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/07/springboot/">
                        <span class="hidden-mobile">springboot</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "ElasticSearch&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
